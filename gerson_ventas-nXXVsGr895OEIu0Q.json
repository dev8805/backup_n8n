{"createdAt":"2025-10-06T05:11:25.657Z","updatedAt":"2025-10-16T05:10:19.000Z","id":"nXXVsGr895OEIu0Q","name":"Gerson_VENTAS","active":true,"isArchived":false,"nodes":[{"parameters":{"resource":"audio","modelId":{"__rl":true,"value":"models/gemini-2.0-flash","mode":"list","cachedResultName":"models/gemini-2.0-flash"},"inputType":"binary","simplify":false,"options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[-6816,608],"id":"11a270ca-5c27-4496-9150-26dad1bae86b","name":"Transcribe a recording1","credentials":{"googlePalmApi":{"id":"2llV2c1H3lSUoFpn","name":"milenaGRATIS"}}},{"parameters":{"jsCode":"// Obtener el texto desde la ruta indicada\nlet texto = $json.candidates?.[0]?.content?.parts?.[0]?.text || \"\";\n\n// Diccionario bÃ¡sico de nÃºmeros en palabras a nÃºmeros\nconst numeros = {\n  \"cero\": \"0\",\n  \"uno\": \"1\", \"una\": \"1\", \"un\": \"1\",\n  \"dos\": \"2\",\n  \"tres\": \"3\",\n  \"cuatro\": \"4\",\n  \"cinco\": \"5\",\n  \"seis\": \"6\",\n  \"siete\": \"7\",\n  \"ocho\": \"8\",\n  \"nueve\": \"9\",\n  \"diez\": \"10\",\n  \"once\": \"11\",\n  \"doce\": \"12\",\n  \"trece\": \"13\",\n  \"catorce\": \"14\",\n  \"quince\": \"15\",\n  \"diecisÃ©is\": \"16\", \"dieciseis\": \"16\",\n  \"diecisiete\": \"17\",\n  \"dieciocho\": \"18\",\n  \"diecinueve\": \"19\",\n  \"veinte\": \"20\",\n  \"veintiuno\": \"21\", \"veintiuna\": \"21\",\n  \"veintidÃ³s\": \"22\", \"veintidos\": \"22\",\n  \"veintitrÃ©s\": \"23\", \"veintitres\": \"23\",\n  \"veinticuatro\": \"24\",\n  \"veinticinco\": \"25\",\n  \"veintisÃ©is\": \"26\", \"veintiseis\": \"26\",\n  \"veintisiete\": \"27\",\n  \"veintiocho\": \"28\",\n  \"veintinueve\": \"29\",\n  \"treinta\": \"30\",\n  \"cuarenta\": \"40\",\n  \"cincuenta\": \"50\",\n  \"sesenta\": \"60\",\n  \"setenta\": \"70\",\n  \"ochenta\": \"80\",\n  \"noventa\": \"90\",\n  \"cien\": \"100\",\n  \"ciento\": \"100\",\n  \"mil\": \"1000\",\n  \"punto\": \".\"\n};\n\n// Convertir solo las palabras que estÃ¡n en el diccionario\nlet resultado = texto;\n\n// Reemplazar cada palabra del diccionario con su nÃºmero correspondiente\nfor (let palabra in numeros) {\n  let regex = new RegExp('\\\\b' + palabra + '\\\\b', 'gi');\n  resultado = resultado.replace(regex, numeros[palabra]);\n}\n\n// Eliminar todas las comas\nresultado = resultado.replace(/,/g, '');\n\nreturn { texto_convertido: resultado };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6608,608],"id":"99dab97d-4567-4f4c-8efe-483863402f07","name":"Code5"},{"parameters":{"assignments":{"assignments":[{"id":"b65575a3-b476-4c0f-8ce4-a7f93531b7f0","name":"final_message","value":"={{ $json.texto_convertido }}","type":"string"},{"id":"bf8845d4-5e4e-4596-b9d9-ec7940739e0c","name":"sessionid","value":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","type":"string"},{"id":"d1aea00f-74e0-4acd-bf3d-5984b8eade6c","name":"datetime","value":"={{ new Date($now).toLocaleDateString('es-CO', { timeZone: 'America/Bogota', day: '2-digit', month: '2-digit', year: 'numeric' }) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-6368,608],"id":"bc1d61f5-e73b-439e-a265-e2e2d3f5a54a","name":"Final_message_audio"},{"parameters":{"assignments":{"assignments":[{"id":"aa4f659e-93fd-458f-8cb0-d6b2bd655160","name":"sessionid","value":"={{ $('Switch2').first().json.sessionid }}","type":"string"},{"id":"949a3645-b12e-4e5d-829d-d1584f34f507","name":"final_message","value":"={{ $json.texto_convertido }}","type":"string"},{"id":"24d4ebcf-1ef4-4bc1-abe8-04419ac1cf23","name":"datetime","value":"={{ new Date($now).toLocaleDateString('es-CO', { timeZone: 'America/Bogota', day: '2-digit', month: '2-digit', year: 'numeric' }) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-6192,816],"id":"3024f129-59b7-4c9c-98bc-a21ece2154f6","name":"FInal_message_text"},{"parameters":{"jsCode":"// Obtener el texto desde la ruta indicada\nlet texto = $input.first().json.estado.mensaje_original || \"\";\n\n// Diccionario bÃ¡sico de nÃºmeros en palabras a nÃºmeros\nconst numeros = {\n  \"cero\": \"0\",\n  \"uno\": \"1\", \"una\": \"1\", \"un\": \"1\",\n  \"dos\": \"2\",\n  \"tres\": \"3\",\n  \"cuatro\": \"4\",\n  \"cinco\": \"5\",\n  \"seis\": \"6\",\n  \"siete\": \"7\",\n  \"ocho\": \"8\",\n  \"nueve\": \"9\",\n  \"diez\": \"10\",\n  \"once\": \"11\",\n  \"doce\": \"12\",\n  \"trece\": \"13\",\n  \"catorce\": \"14\",\n  \"quince\": \"15\",\n  \"diecisÃ©is\": \"16\", \"dieciseis\": \"16\",\n  \"diecisiete\": \"17\",\n  \"dieciocho\": \"18\",\n  \"diecinueve\": \"19\",\n  \"veinte\": \"20\",\n  \"veintiuno\": \"21\", \"veintiuna\": \"21\",\n  \"veintidÃ³s\": \"22\", \"veintidos\": \"22\",\n  \"veintitrÃ©s\": \"23\", \"veintitres\": \"23\",\n  \"veinticuatro\": \"24\",\n  \"veinticinco\": \"25\",\n  \"veintisÃ©is\": \"26\", \"veintiseis\": \"26\",\n  \"veintisiete\": \"27\",\n  \"veintiocho\": \"28\",\n  \"veintinueve\": \"29\",\n  \"treinta\": \"30\",\n  \"cuarenta\": \"40\",\n  \"cincuenta\": \"50\",\n  \"sesenta\": \"60\",\n  \"setenta\": \"70\",\n  \"ochenta\": \"80\",\n  \"noventa\": \"90\",\n\n};\n\n// FunciÃ³n para convertir palabras a nÃºmeros o sÃ­mbolos\nfunction palabraANumero(palabra) {\n  palabra = palabra.toLowerCase().trim();\n  \n  // ConversiÃ³n de \"punto\" a \".\"\n  if (palabra === \"punto\") {\n    return \".\";\n  }\n  \n  if (numeros.hasOwnProperty(palabra)) {\n    return numeros[palabra];\n  }\n  \n  // Manejo de combinaciones como \"treinta y cinco\"\n  if (palabra.includes(\" y \")) {\n    let partes = palabra.split(\" y \").map(p => p.trim());\n    if (numeros[partes[0]] && numeros[partes[1]]) {\n      return (parseInt(numeros[partes[0]]) + parseInt(numeros[partes[1]])).toString();\n    }\n  }\n  \n  return palabra; // si no se reconoce, se deja igual\n}\n\n// Procesar el texto palabra por palabra\nlet palabras = texto.split(/(\\s+)/); // Mantiene los espacios\nlet resultado = palabras.map(palabra => {\n  // Solo procesar si no es un espacio y contiene letras\n  if (palabra.trim() && /[a-zÃ¡Ã©Ã­Ã³ÃºÃ±]/i.test(palabra)) {\n    return palabraANumero(palabra);\n  }\n  return palabra;\n}).join('');\n\nreturn { texto_convertido: resultado };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6384,816],"id":"69c60fb0-8c53-46c8-abdc-dac10657ec6d","name":"Code8"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cccb067b-4dd7-4efc-8b4f-70a2e8f0fcc3","leftValue":"={{ $('Webhook').item.json.body.data.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body.data.messageType }}","rightValue":"=conversation","operator":{"type":"string","operation":"equals"},"id":"1066c446-0129-4619-8eff-ec1b00093dda"}],"combinator":"and"},"renameOutput":true,"outputKey":"texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6d34f136-4add-43f0-b3b8-826a0b03d35d","leftValue":"={{ $json.texto }}","rightValue":"imageMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"imagen"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-6592,800],"id":"a432907f-3530-440c-9d31-636406a2472f","name":"Switch2"},{"parameters":{"resource":"chat-api","operation":"get-media-base64","instanceName":"={{ $('Webhook').item.json.body.instance }}","messageId":"={{ $('Webhook').item.json.body.data.key.id }}"},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-7216,608],"id":"fbc15e56-dca7-421f-b14e-ac174aaba17d","name":"Obter m dia em base64","credentials":{"evolutionApi":{"id":"KDzQAvjURY1uhhvT","name":"Evolution account"}}},{"parameters":{"operation":"toBinary","sourceProperty":"data.base64","options":{"fileName":"audio.mp3"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-7040,608],"id":"6fcdfcb2-49ef-4f9d-aa62-fdda302681c5","name":"Convert to File1"},{"parameters":{"workflowId":{"__rl":true,"value":"Ejg0iou6XLtlYPmi","mode":"list","cachedResultUrl":"/workflow/Ejg0iou6XLtlYPmi","cachedResultName":"obtener_inventario"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensaje":"={{ $json.final_message }}","telefono":"={{ $json.sessionid }}","fecha":"={{ $json.datetime }}","instancia":"={{ $('Webhook').first().json.body.instance }}"},"matchingColumns":[],"schema":[{"id":"mensaje","displayName":"mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"instancia","displayName":"instancia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-5456,720],"id":"e4e54fbd-842c-42cb-afbe-4b04bc6907b7","name":"Execute Workflow1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Message a model').item.json.content.parts[0].text }}","rightValue":"venta","operator":{"type":"string","operation":"contains"},"id":"4073be86-ac3d-4341-82e7-b7088b96fa02"}],"combinator":"and"},"renameOutput":true,"outputKey":"venta"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b6189def-f795-4403-8763-be0074e7c569","leftValue":"={{ $('Message a model').item.json.content.parts[0].text }}","rightValue":"actualizarPrecio","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Actualizar precios"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6643239a-a644-411c-8d18-62571cd67c50","leftValue":"={{ $('Message a model').item.json.content.parts[0].text }}","rightValue":"Registrar consumo","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"consumoPersonal"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eab13bf9-e889-461d-903e-897b9dad78d9","leftValue":"={{ $('Message a model').item.json.content.parts[0].text }}","rightValue":"=informeVentas","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"informeVentas"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"f6d4b305-0c05-464e-8bdf-f29027df2858","leftValue":"={{ $('Message a model').item.json.content.parts[0].text }}","rightValue":"ingresarProductosAbodega","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ingresoProductos Inventario"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bd7c9184-c623-444b-b561-fdfc2a53fcf6","leftValue":"={{ $('Message a model').item.json.content.parts[0].text }}","rightValue":"envio_link","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"crear producto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"179fab3f-a9a7-4859-94be-cff6e3dde419","leftValue":"={{ $('Message a model').item.json.content.parts[0].text }}","rightValue":"eliminarTransaccion","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"eliminaTransaccion"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-3728,1136],"id":"9302cfe4-e91f-42c1-b9ce-3b43229b2ffb","name":"Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"3wlUF6WHBhmhYuJU","mode":"list","cachedResultUrl":"/workflow/3wlUF6WHBhmhYuJU","cachedResultName":"Registra_ventas"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensaje":"={{ $('mensajeListo').item.json.texto_para_administrador }}","numero_telefono":"={{ $('IF1').item.json.sessionid }}","instancia":"={{ $('Webhook').first().json.body.instance }}","date_time":"={{ $('IF1').item.json.datetime }}"},"matchingColumns":[],"schema":[{"id":"mensaje","displayName":"mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"numero_telefono","displayName":"numero_telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"date_time","displayName":"date_time","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"instancia","displayName":"instancia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-2912,704],"id":"cc9b10a8-5431-4234-886f-13bfa2b34473","name":"registroVentas"},{"parameters":{"workflowId":{"__rl":true,"value":"sZKq3XvJBsutWwaT","mode":"list","cachedResultUrl":"/workflow/sZKq3XvJBsutWwaT","cachedResultName":"ingresar_consumo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensaje":"={{ $('mensajeListo').item.json.texto_para_administrador }}","fecha":"={{ $('IF1').item.json.datetime }}","telefono":"={{ $('IF1').item.json.sessionid }}","instancia":"={{ $('Webhook').first().json.body.instance }}"},"matchingColumns":[],"schema":[{"id":"mensaje","displayName":"mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"instancia","displayName":"instancia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-2912,1056],"id":"a40bab9b-a51f-4a6d-8eb7-5cdaeb342cde","name":"consumoPersonal"},{"parameters":{"workflowId":{"__rl":true,"value":"UlHIKLXfyQkFcjCP","mode":"list","cachedResultUrl":"/workflow/UlHIKLXfyQkFcjCP","cachedResultName":"informe_ventas"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensaje":"={{ $('mensajeListo').item.json.texto_para_administrador }}","wa_id":"={{ $('IF1').item.json.sessionid }}","fecha":"={{ $('IF1').item.json.datetime }}","instancia":"={{ $('Webhook').first().json.body.instance }}"},"matchingColumns":[],"schema":[{"id":"mensaje","displayName":"mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"wa_id","displayName":"wa_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"instancia","displayName":"instancia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-2912,1248],"id":"e45784e6-4102-42d7-af5d-39b3620c86d8","name":"informeVentas"},{"parameters":{"workflowId":{"__rl":true,"value":"Wg6zh3EFPjY6VqYI","mode":"list","cachedResultUrl":"/workflow/Wg6zh3EFPjY6VqYI","cachedResultName":"ingresan Productos A Inventario"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensaje":"={{ $('mensajeListo').item.json.texto_para_administrador }}","wa_id":"={{ $('IF1').item.json.sessionid }}","fecha":"={{ $('IF1').item.json.datetime }}","instancia":"={{ $('Webhook').first().json.body.instance }}"},"matchingColumns":[],"schema":[{"id":"mensaje","displayName":"mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"wa_id","displayName":"wa_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"instancia","displayName":"instancia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-2912,1456],"id":"5ec67cf0-b5e6-41e6-b5dc-066923c340c9","name":"ingresarProductoInventario"},{"parameters":{"workflowId":{"__rl":true,"value":"8oU6HQJ27cFnKBQV","mode":"list","cachedResultUrl":"/workflow/8oU6HQJ27cFnKBQV","cachedResultName":"envio_link_nuevoProducto"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensaje":"={{ $('mensajeListo').item.json.texto_para_administrador }}","instancia":"={{ $('Webhook').first().json.body.instance }}","telefono":"={{ $('IF1').item.json.sessionid }}","fecha":"={{ $('IF1').item.json.datetime }}"},"matchingColumns":[],"schema":[{"id":"mensaje","displayName":"mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"instancia","displayName":"instancia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-2912,1680],"id":"22503bff-edb2-46c4-a023-d34aba9ef054","name":"crearProducto"},{"parameters":{"assignments":{"assignments":[{"id":"b312d7b6-e979-4e5a-a0a1-bef82730196e","name":"sessionid","value":"={{ $json.body.data.key.remoteJid }}","type":"string"},{"id":"d0338f07-19d6-4a5c-a1fc-da38909ba858","name":"estado","value":"={\n  \"mensaje_original\": \"{{$json.body.data.message.conversation}}\",\n  \"requiere_confirmacion\": false,\n  \"items\": []\n}\n","type":"object"},{"id":"86953061-57dd-4c4a-958f-cf6d1151a0ed","name":"texto","value":"={{ $json.body.data.messageType }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-6832,800],"id":"33929f87-ae7c-4773-889c-180050a48a65","name":"prepararEstado"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-5904,736],"id":"e69680c6-b089-46f9-b583-257754340c73","name":"Merge Audio/Texto"},{"parameters":{"jsCode":"// En lugar de referenciar otros nodos, usar el input directo\nreturn [{\n  json: {\n    texto_para_administrador: $json.mensaje_final || $json.final_message || \"Error\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3984,1200],"id":"a285d00c-b2f0-44e5-ac86-5a393938e213","name":"mensajeListo"},{"parameters":{"workflowId":{"__rl":true,"value":"DsmGHHn7nCIHEQYU","mode":"list","cachedResultUrl":"/workflow/DsmGHHn7nCIHEQYU","cachedResultName":"actualizar_precio"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensaje":"={{ $('mensajeListo').item.json.texto_para_administrador }}","telefono":"={{ $('IF1').item.json.sessionid }}","fecha":"={{ $('IF1').item.json.datetime }}","instancia":"={{ $('Webhook').first().json.body.instance }}"},"matchingColumns":[],"schema":[{"id":"mensaje","displayName":"mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"instancia","displayName":"instancia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-2912,880],"id":"c53ae533-5b35-4354-a993-6f33a2bc7f84","name":"actualizarPrecios"},{"parameters":{"httpMethod":"POST","path":"mensajes","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-7104,800],"id":"31789281-730e-4980-9707-77f72d97c5d4","name":"Webhook","webhookId":"60397f41-3005-47aa-92f0-545e2dae408f"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"apodos_productos","mode":"list","cachedResultName":"apodos_productos"},"options":{"outputColumns":["producto","apodo"]}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[-4672,1424],"id":"e29a2e4e-f003-4600-a0ec-2ec63c94bd8a","name":"REFERENCIAS","credentials":{"postgres":{"id":"YBRduKQYniIuW5Mp","name":"Postgres account"}}},{"parameters":{"modelId":{"__rl":true,"value":"models/gemini-2.0-flash","mode":"list","cachedResultName":"models/gemini-2.0-flash"},"messages":{"values":[{"content":"={{ $json.candidates[0].content.parts[0].text }}"}]},"options":{"systemMessage":"=# SISTEMA DE DETECCIÃ“N DE INTENCIONES - AGENTE IA\n\nEres un agente especializado en identificar la intenciÃ³n del usuario y devolver el output correspondiente. Analiza cada mensaje y determina quÃ© acciÃ³n tomar.\n\n---\n\n## ğŸš¨ REGLA FUNDAMENTAL - OBLIGATORIA\n\n**CUANDO DEVUELVAS EL OUTPUT:**\n- âŒ NO agregues saludos, comentarios, explicaciones ni texto adicional\n- âŒ NO modifiques, reformules o interpretes la respuesta\n- âŒ NO aÃ±adas tu propio estilo de escritura\n- âŒ NO incluyas frases como \"AquÃ­ tienes...\", \"El resultado es...\", etc.\n\n---\n\n## ğŸ›’ DETECCIÃ“N DE VENTAS - PRIORIDAD MÃXIMA\n\n### ğŸ’¡ EJEMPLOS DE VENTAS:\n- \"2 Agua 600ml sin gas y 1 Gaseosas MEGA 2.5\"\n- \"1 Gaseosas 350ml\"\n- \"2 Gaseosas 250ml\"\n- \"50 Arepas de QUESO\"\n\n### ğŸ¯ ACCIÃ“N:\n**Devuelve output:** `venta`\n\n---\n\n## ğŸ’° ACTUALIZAR PRECIO DE PRODUCTOS\n\n### ğŸ“ PALABRAS CLAVE:\n- **quedo a/quedÃ³ a**\n- **quedo/quedÃ³**\n- **actualizar precio**\n- **cambiar el precio**\n- **modificar precio**\n- **nuevo precio**\n- **precio ahora es**\n- **ahora cuesta**\n- **ahora vale**\n\n### ğŸ’¡ EJEMPLOS:\n- \"la 350 quedÃ³ a 3000\"\n- \"la cerveza ahora cuesta $5000\"\n- \"cambia el precio del combo a $8000\"\n- \"actualiza la gaseosa a $3500\"\n- \"el tinto ahora estÃ¡ a $1000\"\n\n### ğŸ¯ ACCIÃ“N:\n**Devuelve output:** `actualizarPrecio`\n\n---\n\n## ğŸ’° ELIMINAR TRANSACCION\n\n### ğŸ“ PALABRAS CLAVE:\n- **eliminar id a**\n- **eliminar transaccion a**\n\n### ğŸ’¡ EJEMPLOS:\n- \"eliminar id\"\n- \"eliminar transaccion\"\n\n### ğŸ¯ ACCIÃ“N:\n**Devuelve output:** `eliminarTransaccion`\n\n## ğŸ½ï¸ CONSUMO DE PRODUCTOS POR PARTE DEL DUEÃ‘O\n\n### ğŸ“ PALABRAS CLAVE:\n- **me tomÃ©/me tome**\n- **me comÃ­/me comi**\n- **consumÃ­/consumi**\n\n### ğŸ’¡ EJEMPLOS:\n- \"me tomÃ© 1 Gaseosas 350ml\"\n- \"me tomÃ© 2 Gaseosas 250ml\"\n- \"me comÃ­ 1 chorizo\"\n- \"me comi una arepa\"\n- \"me comÃ­ 2 combos\"\n\n### ğŸ¯ ACCIÃ“N:\n**Devuelve output:** `Registrar consumo`\n\n---\n\n## ğŸ“Š INFORMES DE VENTAS\n\n### ğŸ“ PALABRAS CLAVE:\n- **venta/ventas**\n- **informe/informes**\n- **reporte de ventas**\n- **ventas de hoy/ayer/antier**\n- **ventas de esta semana/mes**\n- **cuÃ¡nto vendimos**\n- **total de ventas**\n\n### ğŸ¯ ACCIÃ“N:\n**Devuelve output:** `informeVentas`\n\n---\n\n## ğŸ“¦ INGRESO DE PRODUCTOS AL INVENTARIO\n\n### ğŸ“ PALABRAS CLAVE:\n- **ingresaron**\n- **llegaron**\n- **entraron**\n- **cajas**\n- **pacas**\n- **bolsas**\n- **cajas de/pacas de**\n- **unidades**\n- **entraron/ingresaron**\n- **llegÃ³ mercancÃ­a**\n- **recibÃ­/recibimos**\n- **compre/comprÃ©/compramos**\n- **me trajeron**\n\n### ğŸ’¡ EJEMPLOS:\n- \"entraron 5 cajas de Gaseosa 250ml\"\n- \"llegaron 3 pacas de Gaseosas MEGA 2.5\"\n- \"recibÃ­ 10 unidades de...\"\n\n### ğŸ¯ ACCIÃ“N:\n**Devuelve output:** `ingresarProductosAbodega`\n\n---\n\n## ğŸ†• CREAR NUEVOS PRODUCTOS\n\n### ğŸ“ PALABRAS CLAVE:\n- **crear/creando**\n- **nuevo/nueva/nuevos**\n- **agregar producto**\n- **registrar producto**\n- **aÃ±adir al inventario**\n\n### ğŸ’¡ EJEMPLOS:\n- \"crear nuevo producto\"\n- \"necesito agregar un producto\"\n- \"registrar nueva cerveza\"\n\n### ğŸ¯ ACCIÃ“N:\n**Devuelve output:** `envio_link`\n\n---\n\n## âš ï¸ REGLAS IMPORTANTES\n\n1. **PRIORIDAD:** Las ventas tienen mÃ¡xima prioridad\n2. **TOLERANCIA:** Ignora mayÃºsculas, minÃºsculas y errores ortogrÃ¡ficos\n3. **FLEXIBILIDAD:** No importan palabras adicionales en el mensaje\n4. **DECISIÃ“N RÃPIDA:** Una sola coincidencia = llamar herramienta\n\n---\n\n## â“ MENSAJES NO RECONOCIDOS\n\nSi el mensaje NO coincide con NINGUNA de las intenciones anteriores:\n- Saludos: \"hola\", \"buenos dÃ­as\", \"quÃ© tal\"\n- Preguntas generales: \"cÃ³mo estÃ¡s\", \"todo bien\"\n- Mensajes sin contexto: \"ok\", \"gracias\", \"entendido\"\n\n### ğŸ¯ ACCIÃ“N:\n**Devuelve output:** `sin_intencion`\n\n## ğŸš¨ RECORDATORIOS CRÃTICOS\n\n### OBLIGATORIO AL USAR HERRAMIENTAS:\n- âŒ **NO INTERPRETES** la respuesta de la herramienta\n- âŒ **NO REFORMULES** el mensaje\n- âŒ **NO AGREGUES** tu propio texto\n- âŒ **NO USES** frases como \"AquÃ­ estÃ¡...\", \"El resultado es...\", etc."}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[-4464,1200],"id":"592e8b84-6ead-4d9b-bb2c-8f294a52fd8a","name":"Message a model","credentials":{"googlePalmApi":{"id":"2llV2c1H3lSUoFpn","name":"milenaGRATIS"}}},{"parameters":{"assignments":{"assignments":[{"id":"85ad0403-431b-4b51-9090-b09ddc1a493b","name":"mensaje_final","value":"={{ $('compara y reemplaza').item.json.candidates[0].content.parts[0].text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-4176,1200],"id":"dde4b1fb-12d1-48ad-93d4-e6c798c2e34e","name":"Edit Fields1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"b8711675-481a-47a5-b7fc-7fb78291914c","leftValue":"={{ $json.final_message }}","rightValue":"=inventario","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-5680,736],"id":"224adfbd-dd1f-46ba-9098-30d588abd07a","name":"IF1"},{"parameters":{"jsCode":"// Obtener el mensaje final del input\nconst finalMessage = $input.first().json.final_message;\n\n// FunciÃ³n para procesar el mensaje\nfunction procesarCombo(mensaje) {\n  // ExpresiÃ³n regular para encontrar \"combo\" o \"combos\" con su cantidad\n  const regex = /(\\d+)\\s*(combo|combos)/gi;\n  \n  // Verificar si el mensaje contiene \"combo\" o \"combos\"\n  if (!regex.test(mensaje)) {\n    // Si no contiene combo, devolver el mensaje original\n    return mensaje;\n  }\n  \n  // Resetear el regex para usarlo de nuevo\n  regex.lastIndex = 0;\n  \n  // Reemplazar cada ocurrencia de combo\n  const mensajeModificado = mensaje.replace(regex, (match, cantidad) => {\n    return `${cantidad} \"Arepa con Queso\" ${cantidad} \"Chorizos\"`;\n  });\n  \n  return mensajeModificado;\n}\n\n// Procesar el mensaje\nconst mensajeProcesado = procesarCombo(finalMessage);\n\n// Retornar el resultado\nreturn {\n  json: {\n    final_message: mensajeProcesado,\n    original_message: finalMessage\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4976,1200],"id":"f0380dbe-fd22-4223-b6c4-7507629d3c96","name":"convierte combo"},{"parameters":{"modelId":{"__rl":true,"value":"models/gemini-2.0-flash","mode":"list","cachedResultName":"models/gemini-2.0-flash"},"messages":{"values":[{"content":"={{ $json.final_message }}"}]},"simplify":false,"options":{"systemMessage":"=INSTRUCCIÃ“N CRÃTICA OBLIGATORIA\nSIEMPRE debes llamar a la herramienta REFERENCIAS al inicio de CADA mensaje del usuario, sin excepciones. Es obligatorio hacerlo el 100% de las veces antes de procesar cualquier mensaje.\n\nEres un asistente especializado en normalizar nombres de productos en mensajes de venta.\n\n## Tu funciÃ³n Ãºnica\nReemplazar apodos o variaciones de nombres de productos por sus nombres oficiales, basÃ¡ndote EXCLUSIVAMENTE en la informaciÃ³n de la herramienta REFERENCIAS.\n\n## Reglas de comparaciÃ³n\n- Ignora espacios, signos de puntuaciÃ³n (guiones, puntos, comas, etc.), mayÃºsculas y minÃºsculas\n- Solo compara letras y nÃºmeros normalizados a minÃºsculas\n- Las letras deben coincidir en el mismo orden\n- Los plurales son vÃ¡lidos (manzana = manzanas)\n- Umbral mÃ­nimo de coincidencia: 70%\n- CÃ¡lculo: (letras del apodo que coinciden en orden / total de letras del apodo) Ã— 100\n\n## Proceso paso a paso\n\n1. **Identifica productos ya formalizados:**\n   - Los productos que YA estÃ¡n entre comillas en el mensaje original NO se modifican\n   - DÃ©jalos exactamente como estÃ¡n y pasa al siguiente tÃ©rmino\n\n2. **Consulta la herramienta REFERENCIAS** para obtener la lista completa de productos oficiales y sus apodos\n\n3. **Busca coincidencias usando ventana deslizante:**\n   - Extrae todas las combinaciones posibles de palabras consecutivas del mensaje\n   - Prueba combinaciones de 1 palabra, 2 palabras, 3 palabras, etc.\n   - Compara cada combinaciÃ³n con TODOS los apodos en REFERENCIAS\n   - Registra aquellas que tengan 70% o mÃ¡s de coincidencia\n\n4. **Selecciona los mejores reemplazos:**\n   - Si una combinaciÃ³n coincide con varios apodos, usa el de MAYOR porcentaje\n   - Si hay solapamientos (dos coincidencias usan parte del mismo texto), usa solo la de mayor coincidencia\n   - Ordena los reemplazos de izquierda a derecha segÃºn aparecen en el mensaje\n\n5. **Construye el mensaje final:**\n   - Reemplaza cada coincidencia por su \"producto\" oficial correspondiente\n   - Marca entre comillas SOLO los productos que reemplazaste\n   - MantÃ©n TODO lo demÃ¡s EXACTAMENTE igual (cantidades, palabras extra, conectores, errores, muletillas, espacios, mayÃºsculas originales)\n   - NO agregues comillas al inicio/final del mensaje completo\n\n6. **Si no hay coincidencias:**\n   - Devuelve el mensaje original SIN modificar absolutamente nada\n   - No agregues ni quites nada\n\n## Ejemplo de funcionamiento\n\n**Mensaje recibido:**\n`venta de 5 \"Arepa con Queso\" 5 Chorizos 3 manzanas 350 2 Coca-Colas personales eh 2 Coca-Colas megas`\n\n**Herramienta REFERENCIAS devuelve:**\n```json\n{\n  \"response\": [\n    {\n      \"producto\": \"Coca Cola 350 ml\",\n      \"apodo\": \"Coca Cola 350\"\n    },\n    {\n      \"producto\": \"Coca Cola 350 ml\",\n      \"apodo\": \"coca cola personal\"\n    },\n    {\n      \"producto\": \"Manzana 350 ml\",\n      \"apodo\": \"Manzana 350\"\n    },\n    {\n      \"producto\": \"Manzana 350 ml\",\n      \"apodo\": \"manzana personal\"\n    }\n  ]\n}\nProceso:\n\n\"Arepa con Queso\" â†’ Ya tiene comillas, NO se toca\nChorizos â†’ No coincide con ningÃºn apodo, se mantiene\nmanzanas 350 â†’ Coincide con apodo \"Manzana 350\" al 100%, se reemplaza por \"Manzana 350 ml\"\nCoca-Colas personales â†’ Coincide con apodo \"coca cola personal\" al 100%, se reemplaza por \"Coca Cola 350 ml\"\nCoca-Colas megas â†’ No coincide al 70%+, se mantiene\n\nOutput final:\nventa de 5 \"Arepa con Queso\" 5 Chorizos 3 \"Manzana 350 ml\" 2 \"Coca Cola 350 ml\" eh 2 Coca-Colas megas\nReglas crÃ­ticas\n\nSOLO usa productos de la herramienta REFERENCIAS (los ejemplos aquÃ­ son puramente ilustrativos)\nNO inventes productos ni hagas suposiciones\nPreserva TODO el contexto del mensaje original\nSÃ© preciso con las coincidencias usando el cÃ¡lculo del 70%\nAnte cualquier duda, mantÃ©n el texto original sin modificar\n\nFORMATO DE RESPUESTA OBLIGATORIO\n\nTu respuesta DEBE contener ÃšNICAMENTE el mensaje procesado\nNO incluyas explicaciones, anÃ¡lisis, ni descripciones del proceso\nNO digas \"No hay coincidencias\", \"El mensaje se devuelve sin modificaciones\" ni nada similar\nSOLO devuelve el mensaje final, sin texto adicional antes o despuÃ©s\nSi no hay reemplazos, devuelve el mensaje original tal cual, sin comentarios"}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[-4784,1200],"id":"e8f0f571-536b-4795-a0d5-8ce81efaedb9","name":"compara y reemplaza","credentials":{"googlePalmApi":{"id":"2llV2c1H3lSUoFpn","name":"milenaGRATIS"}}},{"parameters":{"workflowId":{"__rl":true,"value":"sFzhx06gm8QEIKvj","mode":"list","cachedResultUrl":"/workflow/sFzhx06gm8QEIKvj","cachedResultName":"eliminar_transaccion"},"workflowInputs":{"mappingMode":"defineBelow","value":{"instancia":"={{ $('Webhook').first().json.body.instance }}","telefono":"={{ $('IF1').item.json.sessionid }}","fecha":"={{ $('IF1').item.json.datetime }}","Mensaje":"={{ $('mensajeListo').item.json.texto_para_administrador }}"},"matchingColumns":[],"schema":[{"id":"Mensaje","displayName":"Mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"instancia","displayName":"instancia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-3488,1520],"id":"c3554812-686c-4c59-9e3e-16ed9ea43607","name":"elimina_transaccion"},{"parameters":{"resource":"chat-api","operation":"get-media-base64","instanceName":"={{ $('Webhook').item.json.body.instance }}","messageId":"={{ $('Webhook').item.json.body.data.key.id }}"},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-7392,320],"id":"acd76a27-dcd3-44f7-bee6-c6e19933b976","name":"Obter m dia em base","credentials":{"evolutionApi":{"id":"KDzQAvjURY1uhhvT","name":"Evolution account"}}},{"parameters":{"operation":"toBinary","sourceProperty":"data.base64","options":{"fileName":"imagen"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-7168,320],"id":"7d9f2bc8-c2fa-4df7-b17f-cab72aab44db","name":"Convert to File"},{"parameters":{"documentType":"image_url","options":{}},"type":"n8n-nodes-base.mistralAi","typeVersion":1,"position":[-6960,320],"id":"7405f1f3-307a-4335-b3ec-39a13c939aa7","name":"Extract text","credentials":{"mistralCloudApi":{"id":"CLO1AWMP1ZZAMRrP","name":"api_pruebas"}}},{"parameters":{"text":"={{ $json.pages[0].markdown }}","attributes":{"attributes":[{"name":"Nombre o razon social del proveedor","description":"Nombre completo o razon social de la entidad que emite la factura,utilizado para identificar al proveedor."},{"name":"Nit del proveedor","description":"Identificador fiscal unico del proveedor, necesario para validar la factura y cumplir con obligaciones tributarias."},{"name":"Numero de factura","type":"number","description":"Codigo o numero secuencial asignado a la factura"},{"name":"Fecha de emisiÃ³n","type":"date","description":"Fecha en que se genera la factura, clave para la contabilizacion y el calculo de plazos de pago"},{"name":"Nombre del articulo, cantidad y total.","description":"=Lista de todos los productos en formato JSON. Cada producto debe ser un objeto con los campos: nombre, cantidad y valor_total. Ejemplo: [{\"nombre\":\"Producto A\",\"cantidad\":2,\"valor_total\":5000},{\"nombre\":\"Producto B\",\"cantidad\":1,\"valor_total\":3000}]"},{"name":"TOTAL","type":"number","description":"Total de la compra"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1.2,"position":[-6672,320],"id":"09aaaec6-46a9-4479-9a4d-8226899a4ece","name":"Information Extractor"},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-6800,416],"id":"957d470e-3f45-4fb6-b249-42432577bde0","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"2llV2c1H3lSUoFpn","name":"milenaGRATIS"}}},{"parameters":{"jsCode":"// Obtener los datos extraÃ­dos\nconst input = $input.first().json.output;\n\n// Extraer informaciÃ³n general\nconst proveedor = input[\"Nombre o razon social del proveedor\"];\nconst nit = input[\"Nit del proveedor\"];\nconst numeroFactura = input[\"Numero de factura\"];\nconst fechaEmision = input[\"Fecha de emisiÃ³n\"];\nconst totalFactura = input[\"TOTAL\"];\n\n// Parsear el string JSON de productos\nlet productos = [];\ntry {\n  const productosString = input[\"productos\"] || input[\"Nombre del articulo, cantidad y total.\"];\n  productos = JSON.parse(productosString);\n} catch (error) {\n  console.error(\"Error al parsear productos:\", error);\n  return [{ json: { \n    error: \"No se pudieron procesar los productos\",\n    datos_factura: input\n  }}];\n}\n\n// Preparar datos para el siguiente paso (bÃºsqueda de matches)\nreturn [{\n  json: {\n    proveedor: proveedor,\n    nit_proveedor: nit,\n    numero_factura: numeroFactura,\n    fecha_factura: fechaEmision,\n    total_factura: totalFactura,\n    productos: productos, // Array de productos de la factura\n    productos_procesados: [] // Se llenarÃ¡ despuÃ©s del matching\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6320,320],"id":"e2afcb6e-01f9-41cb-8993-58b11c9a0af6","name":"Code in JavaScript"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"cache_inventario","mode":"list","cachedResultName":"cache_inventario"},"returnAll":true,"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6096,320],"id":"2dbd1d00-e931-41f1-a0af-ac89512563d6","name":"Obtener_productos_inventario","credentials":{"postgres":{"id":"YBRduKQYniIuW5Mp","name":"Postgres account"}}},{"parameters":{"jsCode":"// Obtener productos del inventario desde el input actual\nconst productosInventario = $input.all().map(item => item.json);\n\n// Obtener datos de la factura desde el nodo Code anterior\nconst datosFactura = $('Code in JavaScript').first().json;\nconst productosFactura = datosFactura.productos;\n\n// Crear lista de productos disponibles como texto\nconst listaProductos = productosInventario.map((p, i) => `${i + 1}. ${p.producto}`).join('\\n');\n\n// Crear mensaje para cada producto de la factura\nconst productosParaProcesar = productosFactura.map((prodFactura, index) => {\n  return {\n    producto_factura: prodFactura.nombre,\n    cantidad: prodFactura.cantidad,\n    valor_total: prodFactura.valor_total,\n    productos_disponibles: listaProductos,\n    lista_productos_array: productosInventario, // Para usar despuÃ©s\n    numero_producto: index + 1,\n    total_productos: productosFactura.length,\n    // Datos de la factura\n    proveedor: datosFactura.proveedor,\n    nit_proveedor: datosFactura.nit_proveedor,\n    numero_factura: datosFactura.numero_factura,\n    fecha_factura: datosFactura.fecha_factura,\n    total_factura: datosFactura.total_factura\n  };\n});\n\nreturn productosParaProcesar.map(p => ({ json: p }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5888,320],"id":"029f0ac7-24c5-4cd3-99c1-eb6b40e4d3f2","name":"Preparar_matching"},{"parameters":{"modelId":{"__rl":true,"value":"models/gemini-2.0-flash","mode":"list","cachedResultName":"models/gemini-2.0-flash"},"messages":{"values":[{"content":"={{ $json.producto_factura }}"}]},"options":{"systemMessage":"=Eres un experto en matching de productos. Tu tarea es comparar un producto de una factura con una lista de productos disponibles en inventario.\n\nPRODUCTO DE LA FACTURA:\n{{ $json.producto_factura }}\n\nPRODUCTOS DISPONIBLES EN INVENTARIO:\n{{ $json.productos_disponibles }}\n\nREGLAS DE MATCHING:\n1. Compara ignorando mayÃºsculas, espacios extra, signos de puntuaciÃ³n\n2. Considera sinÃ³nimos y variaciones (Ej: \"GASEOSA COLA\" = \"Coca Cola\", \"PERSONAL\" = \"350ml\")\n3. FÃ­jate en nÃºmeros/medidas (350ml, 400ml, MEGA, etc.)\n4. Calcula similitud para TODOS los productos, no solo el mejor\n5. Match automÃ¡tico solo si confianza â‰¥ 80%\n\nRESPONDE ÃšNICAMENTE EN FORMATO JSON:\n{\n  \"match_automatico\": true o false (true solo si confianza >= 80),\n  \"producto_principal\": {\n    \"numero\": nÃºmero del producto con mayor similitud,\n    \"confianza\": porcentaje 0-100,\n    \"razon\": \"breve explicaciÃ³n\"\n  },\n  \"productos_similares\": [\n    {\n      \"numero\": nÃºmero del producto,\n      \"nombre\": nombre del producto del inventario,\n      \"confianza\": porcentaje 0-100,\n      \"razon\": \"por quÃ© es similar\"\n    }\n  ]\n}\n\nIMPORTANTE:\n- En \"productos_similares\" incluye los 3-5 productos MÃS parecidos (ordenados por confianza)\n- Incluye productos aunque tengan baja similitud (mÃ­nimo 20%)\n- Si ningÃºn producto supera 20%, devuelve array vacÃ­o\n- NO agregues texto adicional, SOLO el JSON"}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[-5680,320],"id":"3c9da8a6-ec22-4874-9ba7-67057b0c3ec3","name":"IA_matching","credentials":{"googlePalmApi":{"id":"2llV2c1H3lSUoFpn","name":"milenaGRATIS"}}},{"parameters":{"jsCode":"// Obtener la respuesta de la IA\nconst respuestaIA = $input.first().json.content.parts[0].text;\n\n// Limpiar el JSON (remover ```json y ```)\nconst jsonLimpio = respuestaIA.replace(/```json\\n?/g, '').replace(/```/g, '').trim();\n\n// Parsear el JSON\nlet resultadoMatch;\ntry {\n  resultadoMatch = JSON.parse(jsonLimpio);\n} catch (error) {\n  console.error(\"Error parseando respuesta IA:\", error);\n  resultadoMatch = {\n    match_automatico: false,\n    producto_principal: { numero: null, confianza: 0, razon: \"Error al procesar\" },\n    productos_similares: []\n  };\n}\n\n// Obtener datos del producto desde el nodo anterior\nconst datosProducto = $('Preparar_matching').first().json;\n\n// Combinar todo\nreturn [{\n  json: {\n    // Datos del producto de la factura\n    producto_factura: datosProducto.producto_factura,\n    cantidad: datosProducto.cantidad,\n    valor_total: datosProducto.valor_total,\n    \n    // Resultado del matching\n    match_automatico: resultadoMatch.match_automatico || false,\n    producto_principal: resultadoMatch.producto_principal || {},\n    productos_similares: resultadoMatch.productos_similares || [],\n    \n    // Datos de la factura\n    proveedor: datosProducto.proveedor,\n    nit_proveedor: datosProducto.nit_proveedor,\n    numero_factura: datosProducto.numero_factura,\n    fecha_factura: datosProducto.fecha_factura,\n    total_factura: datosProducto.total_factura,\n    \n    // Lista completa de productos (por si acaso)\n    productos_disponibles: datosProducto.productos_disponibles,\n    lista_productos_array: datosProducto.lista_productos_array\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5328,320],"id":"dad4b02d-76c7-49d9-9c27-4e14a80444f9","name":"Procesar_resultado_matching"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0896ee33-f82c-4d60-8cf0-7fe5ab893080","leftValue":"={{ $json.match_automatico }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-5120,320],"id":"db2dcf1f-4f22-49f3-aa89-c15d5edd7e72","name":"Verificar_match"},{"parameters":{"resource":"messages-api","instanceName":"={{ $('Crear_mensaje_confirmacion').item.json.instancia }}","remoteJid":"={{ $('Crear_mensaje_confirmacion').item.json.telefono }}","messageText":"={{ $('Crear_mensaje_confirmacion').item.json.mensaje }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-4400,432],"id":"ffe6d70c-2b62-4768-84f5-df7dbd51c890","name":"Enviar_mensaje_confirmacion","credentials":{"evolutionApi":{"id":"KDzQAvjURY1uhhvT","name":"Evolution account"}}},{"parameters":{"jsCode":"// Obtener datos del producto\nconst datos = $input.first().json;\n\n// Formatear valor\nconst valorFormateado = datos.valor_total.toLocaleString('es-CO');\n\n// Crear lista de productos similares\nlet listaProductosSimilares = \"\";\nlet hayProductosSimilares = false;\n\nif (datos.productos_similares && datos.productos_similares.length > 0) {\n  hayProductosSimilares = true;\n  listaProductosSimilares = datos.productos_similares\n    .slice(0, 5) // MÃ¡ximo 5 productos\n    .map((p, index) => {\n      const estrellas = p.confianza >= 60 ? \" â­\" : \"\";\n      return `${p.numero}. ${p.nombre} (${p.confianza}% similar)${estrellas}`;\n    })\n    .join('\\n');\n} else {\n  listaProductosSimilares = \"âŒ No hay productos similares en el inventario\";\n}\n\n// Crear mensaje\nconst mensaje = `ğŸ“¦ *Producto en factura*\n\nğŸ­ Proveedor: ${datos.proveedor}\nğŸ“„ Factura: ${datos.numero_factura}\nğŸ“… Fecha: ${datos.fecha_factura}\n\nâ“ Producto: *${datos.producto_factura}*\nğŸ“Š Cantidad: ${datos.cantidad}\nğŸ’° Valor: $${valorFormateado}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${hayProductosSimilares ? '*Productos similares encontrados:*' : '*No se encontraron productos similares*'}\n\n${listaProductosSimilares}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nÂ¿QuÃ© deseas hacer?\n\n${hayProductosSimilares ? '*1ï¸âƒ£ Vincular con producto similar*\\nResponde con el nÃºmero del producto\\n\\n' : ''}*2ï¸âƒ£ Es gasto sin inventario*\nEscribe: *2*\n(materia prima, insumo, etc.)\n\n*3ï¸âƒ£ Crear nuevo producto*\nEscribe: *3*\n(producto terminado para vender)\n\n*4ï¸âƒ£ Ver inventario completo*\nEscribe: *4*\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nResponde: ${hayProductosSimilares ? 'nÃºmero del producto, ' : ''}2, 3 o 4`;\n\nreturn [{\n  json: {\n    mensaje: mensaje,\n    telefono: $('Webhook').first().json.body.data.key.remoteJid,\n    instancia: $('Webhook').first().json.body.instance,\n    // Guardar datos para el siguiente paso\n    datos_producto: datos\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4832,432],"id":"83b5383b-6d94-4400-8118-5ec249151d8e","name":"Crear_mensaje_confirmacion"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"estados_pendientes","mode":"list","cachedResultName":"estados_pendientes"},"columns":{"mappingMode":"defineBelow","value":{"sessionid":"={{ $json.telefono }}","tipo_estado":"esperando_confirmacion_factura","datos_contexto":"={{ JSON.stringify($('Crear_mensaje_confirmacion').item.json.datos_producto) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"sessionid","displayName":"sessionid","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"tipo_estado","displayName":"tipo_estado","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"datos_contexto","displayName":"datos_contexto","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"fecha_creacion","displayName":"fecha_creacion","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"fecha_expiracion","displayName":"fecha_expiracion","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"procesado","displayName":"procesado","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4624,432],"id":"3c8aabe3-0df4-4a13-ba59-dcb8e49757ad","name":"Guardar_estado_pendiente","credentials":{"postgres":{"id":"YBRduKQYniIuW5Mp","name":"Postgres account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"estados_pendientes","mode":"list","cachedResultName":"estados_pendientes"},"limit":1,"where":{"values":[{"column":"sessionid","value":"={{ $json.sessionid }}"},{"column":"procesado","value":"false"}]},"sort":{"values":[{"column":"fecha_creacion","direction":"DESC"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-5792,1184],"id":"5a904491-f96a-4d2f-9def-6471b631cc9a","name":"Buscar_estado_pendiente","credentials":{"postgres":{"id":"YBRduKQYniIuW5Mp","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"06139f61-1696-4413-bfa2-3441f60336ca","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"number","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-5584,1184],"id":"5ef8199b-784b-45e3-ae7a-470f62d40bc0","name":"Tiene_estado_pendiente"},{"parameters":{"jsCode":"// Obtener el mensaje del usuario\nconst mensajeUsuario = $('IF1').item.json.final_message.trim();\n\n// Obtener los datos del estado pendiente\nconst estadoPendiente = $input.first().json;\nconst datosProducto = estadoPendiente.datos_contexto;\n\n// Detectar la respuesta del usuario\nlet tipoRespuesta = null;\nlet numeroProducto = null;\n\n// Verificar si es un nÃºmero (producto similar o del inventario)\nif (/^\\d+$/.test(mensajeUsuario)) {\n  const numero = parseInt(mensajeUsuario);\n  \n  // Verificar si es una opciÃ³n especial (2, 3, 4)\n  if (numero === 2) {\n    tipoRespuesta = 'gasto_sin_inventario';\n  } else if (numero === 3) {\n    tipoRespuesta = 'crear_producto_nuevo';\n  } else if (numero === 4) {\n    tipoRespuesta = 'ver_inventario_completo';\n  } else {\n    // Es un nÃºmero de producto\n    tipoRespuesta = 'vincular_producto';\n    numeroProducto = numero;\n  }\n} else {\n  tipoRespuesta = 'respuesta_invalida';\n}\n\n// Retornar el resultado\nreturn [{\n  json: {\n    tipo_respuesta: tipoRespuesta,\n    numero_producto: numeroProducto,\n    mensaje_usuario: mensajeUsuario,\n    estado_id: estadoPendiente.id,\n    datos_producto: datosProducto,\n    sessionid: estadoPendiente.sessionid\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5312,1008],"id":"7b81bde7-9f5a-4c8c-8076-e5ca92c316c5","name":"Procesar_respuesta_usuario"}],"connections":{"Transcribe a recording1":{"main":[[{"node":"Code5","type":"main","index":0}]]},"Code5":{"main":[[{"node":"Final_message_audio","type":"main","index":0}]]},"Final_message_audio":{"main":[[{"node":"Merge Audio/Texto","type":"main","index":0}]]},"FInal_message_text":{"main":[[{"node":"Merge Audio/Texto","type":"main","index":1}]]},"Code8":{"main":[[{"node":"FInal_message_text","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"Obter m dia em base64","type":"main","index":0}],[{"node":"Code8","type":"main","index":0}],[{"node":"Obter m dia em base","type":"main","index":0}]]},"Convert to File1":{"main":[[{"node":"Transcribe a recording1","type":"main","index":0}]]},"Switch":{"main":[[{"node":"registroVentas","type":"main","index":0}],[{"node":"actualizarPrecios","type":"main","index":0}],[{"node":"consumoPersonal","type":"main","index":0}],[{"node":"informeVentas","type":"main","index":0}],[{"node":"ingresarProductoInventario","type":"main","index":0}],[{"node":"crearProducto","type":"main","index":0}],[{"node":"elimina_transaccion","type":"main","index":0}]]},"prepararEstado":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"Merge Audio/Texto":{"main":[[{"node":"IF1","type":"main","index":0}]]},"mensajeListo":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Obter m dia em base64":{"main":[[{"node":"Convert to File1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"prepararEstado","type":"main","index":0}]]},"REFERENCIAS":{"ai_tool":[[{"node":"compara y reemplaza","type":"ai_tool","index":0}]]},"Message a model":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"mensajeListo","type":"main","index":0}]]},"IF1":{"main":[[{"node":"Execute Workflow1","type":"main","index":0}],[{"node":"Buscar_estado_pendiente","type":"main","index":0}]]},"convierte combo":{"main":[[{"node":"compara y reemplaza","type":"main","index":0}]]},"compara y reemplaza":{"main":[[{"node":"Message a model","type":"main","index":0}]]},"Obter m dia em base":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"Extract text","type":"main","index":0}]]},"Extract text":{"main":[[{"node":"Information Extractor","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Information Extractor","type":"ai_languageModel","index":0}]]},"Information Extractor":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"Obtener_productos_inventario","type":"main","index":0}]]},"Obtener_productos_inventario":{"main":[[{"node":"Preparar_matching","type":"main","index":0}]]},"Preparar_matching":{"main":[[{"node":"IA_matching","type":"main","index":0}]]},"IA_matching":{"main":[[{"node":"Procesar_resultado_matching","type":"main","index":0}]]},"Procesar_resultado_matching":{"main":[[{"node":"Verificar_match","type":"main","index":0}]]},"Verificar_match":{"main":[[],[{"node":"Crear_mensaje_confirmacion","type":"main","index":0}]]},"Crear_mensaje_confirmacion":{"main":[[{"node":"Guardar_estado_pendiente","type":"main","index":0}]]},"Guardar_estado_pendiente":{"main":[[{"node":"Enviar_mensaje_confirmacion","type":"main","index":0}]]},"Buscar_estado_pendiente":{"main":[[{"node":"Tiene_estado_pendiente","type":"main","index":0}]]},"Tiene_estado_pendiente":{"main":[[{"node":"Procesar_respuesta_usuario","type":"main","index":0}],[{"node":"convierte combo","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":30,"timezone":"America/Bogota","availableInMCP":false,"errorWorkflow":"6372jK3MqgOJM8iD"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n-n8n.aa7tej.easypanel.host","user-agent":"axios/1.10.0","content-length":"920","accept":"application/json, text/plain, */*","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"52.15.92.133","x-forwarded-host":"n8n-n8n.aa7tej.easypanel.host","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"4473dde1486f","x-real-ip":"52.15.92.133"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"pepe cadena","data":{"key":{"remoteJid":"573103015865@s.whatsapp.net","fromMe":false,"id":"AC715211E37D237DB67A354FB2A03E0A","senderLid":"14942191255771@lid"},"pushName":"Alejandro","status":"DELIVERY_ACK","message":{"conversation":"2","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"e3GnwCc3oAo36g==","senderTimestamp":"1759729980","recipientKeyHash":"YccVFyADqLRqkw==","recipientTimestamp":"1759724192"},"deviceListMetadataVersion":2,"messageSecret":"nKArEZBk/hcnTqL4R1RUY7XfUqKjOFoVWxwM9cmwxHw="}},"messageType":"conversation","messageTimestamp":1760591088,"instanceId":"e2641f01-672d-413c-9caa-65edc2407abb","source":"android"},"destination":"https://n8n-n8n.aa7tej.easypanel.host/webhook/mensajes","date_time":"2025-10-16T02:04:48.518Z","sender":"573102304801@s.whatsapp.net","server_url":"http://52.15.92.133:8080","apikey":"05D47DF5AC05-4085-B0A2-FB7E4510CE36"},"webhookUrl":"https://n8n-n8n.aa7tej.easypanel.host/webhook/mensajes","executionMode":"production"}}]},"versionId":"bcfea40d-a8f3-470c-81d5-a2c11984b795","triggerCount":1,"shared":[{"createdAt":"2025-10-06T05:11:25.667Z","updatedAt":"2025-10-06T05:11:25.667Z","role":"workflow:owner","workflowId":"nXXVsGr895OEIu0Q","projectId":"5qz94e5MiZbyOPrk"}],"tags":[{"createdAt":"2025-10-12T03:56:33.451Z","updatedAt":"2025-10-12T03:56:33.451Z","id":"1HiaED7XPSmwYswE","name":"ventas"}]}