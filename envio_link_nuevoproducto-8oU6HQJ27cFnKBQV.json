{"createdAt":"2025-10-06T05:13:56.312Z","updatedAt":"2025-10-19T03:47:35.000Z","id":"8oU6HQJ27cFnKBQV","name":"envio_link_nuevoProducto","active":false,"isArchived":false,"nodes":[{"parameters":{"resource":"messages-api","instanceName":"={{ $('When Executed by Another Workflow').item.json.instancia }}","remoteJid":"={{ $('When Executed by Another Workflow').item.json.telefono }}","messageText":"={{ $json.linkCrear }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[624,-32],"id":"d30d27ce-1a65-42ea-ac97-21e78eac8ee2","name":"Enviar texto","credentials":{"evolutionApi":{"id":"KDzQAvjURY1uhhvT","name":"Evolution account"}}},{"parameters":{"workflowInputs":{"values":[{"name":"tenant_id"},{"name":"user_id"},{"name":"permisos"},{"name":"rol"},{"name":"nombre_usuario"},{"name":"mensaje"},{"name":"numero_telefono"},{"name":"date_time"},{"name":"instancia"},{"name":"autorizado"}]}},"id":"2dd3967f-977e-4b04-a8fb-9f0f5ad49723","typeVersion":1.1,"name":"When Executed by Another Workflow","type":"n8n-nodes-base.executeWorkflowTrigger","position":[-1216,-48]},{"parameters":{"jsCode":"// Verificar si viene pre-autorizado desde gerson_ventas\nif ($json.autorizado === true && $json.tenant_id) {\n  // Parsear permisos si vienen como string\n  let permisos = $json.permisos;\n  if (typeof permisos === 'string') {\n    permisos = JSON.parse(permisos);\n  }\n  \n  return {\n    tenant_id: $json.tenant_id,\n    user_id: $json.user_id,\n    rol: $json.rol,\n    permisos: permisos,\n    nombre_usuario: $json.nombre_usuario,\n    mensaje: $json.mensaje,\n    numero_telefono: $json.numero_telefono,\n    date_time: $json.date_time,\n    instancia: $json.instancia,\n    pre_validado: true\n  };\n} else {\n  // Llamada directa (testing sin gerson_ventas)\n  return {\n    necesita_validacion: true,\n    mensaje: $json.mensaje,\n    numero_telefono: $json.numero_telefono,\n    date_time: $json.date_time,\n    instancia: $json.instancia\n  };\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-496,-32],"id":"77a4daa8-5b96-46ff-9795-dccdc40bf472","name":"Verificar Autorizaci√≥n"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"64263bb7-218a-4965-94ae-f56eba7a053d","leftValue":"={{ $json.necesita_validacion }}","rightValue":"true","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-288,-32],"id":"3f6697c8-6967-47d5-97d8-ce57a5a23eef","name":"Necesita Validaci√≥n?"},{"parameters":{"workflowId":{"__rl":true,"value":"niw7nbWmuCLHmO5F","mode":"list","cachedResultUrl":"/workflow/niw7nbWmuCLHmO5F","cachedResultName":"identificar_tenant"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-112,-240],"id":"79d5d1b6-a4ba-4ab4-819e-7170f1e7bb08","name":"Call 'identificar_tenant'"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"64263bb7-218a-4965-94ae-f56eba7a053d","leftValue":"={{ $json.permisos.productos.crear }}","rightValue":"true","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-48,-16],"id":"0d7ce024-14e1-461e-b8c2-31c5dadd9e8d","name":"Permiso Crear Productos"},{"parameters":{"jsCode":"return {\n  mensaje: `‚ùå ${$json.nombre_usuario || 'Usuario'}, no tienes permiso para crear productos.`\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[160,128],"id":"1c867db3-7216-483c-b7c5-f50f13685a80","name":"sin permiso"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO form_tokens (\n  tenant_id,\n  user_id,\n  tipo_form\n) VALUES (\n  '{{ $json.tenant_id }}',\n  '{{ $json.user_id }}',\n  'crear_producto'\n)\nRETURNING token;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1008,-48],"id":"4e1a39de-40d4-4ee3-8f7b-c80646e4cb20","name":"Generar token","credentials":{"postgres":{"id":"YBRduKQYniIuW5Mp","name":"Postgres account"}}},{"parameters":{"jsCode":"const token = $json.token;\nconst baseUrl = 'https://n8n-n8n.aa7tej.easypanel.host/'; // ‚ö†Ô∏è CAMBIA por tu URL real de N8N\n\nreturn {\n  link: `${baseUrl}/webhook/form-crear-producto?token=${token}`,\n  token: token\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-768,-48],"id":"75de8fbd-64a1-40bf-a122-c156037e7313","name":"Construir link"},{"parameters":{"jsCode":"return {\n  mensaje: `üìù *Formulario de Creaci√≥n de Productos*\\n\\n` +\n           `Accede al siguiente enlace para registrar tu nuevo producto:\\n\\n` +\n           `${$('Construir link').item.json.link}\\n\\n` +\n           `‚ÑπÔ∏è *Informaci√≥n importante:*\\n` +\n           `‚Ä¢ Este enlace es v√°lido por 24 horas\\n` +\n           `‚Ä¢ Solo puede usarse una vez\\n` +\n           `‚Ä¢ Puedes solicitar un nuevo enlace cuando lo necesites escribiendo \"crear producto\"\\n\\n`,\n  phone: $json.session_id || $json.telefono\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[288,-48],"id":"4098c25e-9e1c-4a00-9083-2d28d2e9cfd1","name":"creaMensaje"}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Generar token","type":"main","index":0}]]},"Verificar Autorizaci√≥n":{"main":[[{"node":"Necesita Validaci√≥n?","type":"main","index":0}]]},"Necesita Validaci√≥n?":{"main":[[{"node":"Call 'identificar_tenant'","type":"main","index":0}],[{"node":"Permiso Crear Productos","type":"main","index":0}]]},"Permiso Crear Productos":{"main":[[{"node":"creaMensaje","type":"main","index":0}],[{"node":"sin permiso","type":"main","index":0}]]},"Generar token":{"main":[[{"node":"Construir link","type":"main","index":0}]]},"Construir link":{"main":[[{"node":"Verificar Autorizaci√≥n","type":"main","index":0}]]},"creaMensaje":{"main":[[{"node":"Enviar texto","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Bogota","callerPolicy":"workflowsFromSameOwner","executionTimeout":15,"availableInMCP":false,"errorWorkflow":"6372jK3MqgOJM8iD"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"mensaje":"1 \"Coca Cola 350ml\"\n","numero_telefono":"573103015865@s.whatsapp.net","date_time":"11/10/2025","instancia":"pepe cadena"}}]},"versionId":"0a95dcdc-5464-4852-b260-46bf35b8f226","triggerCount":0,"shared":[{"createdAt":"2025-10-06T05:13:56.317Z","updatedAt":"2025-10-06T05:13:56.317Z","role":"workflow:owner","workflowId":"8oU6HQJ27cFnKBQV","projectId":"5qz94e5MiZbyOPrk"}],"tags":[{"createdAt":"2025-10-12T03:56:33.451Z","updatedAt":"2025-10-12T03:56:33.451Z","id":"1HiaED7XPSmwYswE","name":"ventas"}]}